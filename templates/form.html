{% extends "base.html" %}
{% block content %}
<div style="background-color: #f1f1f1;" style="height: 100vh;" id="page"
    class="container-fluid d-flex justify-content-center">
    <form method="post" class="card shadow mt-5" style="width: 30rem;">
        <div class="card-body">
            <h2 class="card-title">Start Scraping ...</h2>
            <!-- url input -->
            <div class="form-label">URLS</div>
            <div class="d-flex">
                <div>
                    <input style="width: 25rem;" class="form-control mr-2" id="url" />
                </div>
                <button type="button" class="btn btn-secondary" id="addURL" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Add this url">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-plus-circle fw-bold" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path
                            d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    </svg>
                </button>
            </div>
            <!-- url collapse -->
            <div class="d-inline-block mt-2">
                <div id="urlCounter"></div>
                <a role="button" href="" data-bs-toggle="collapse" data-bs-target="#collapseExample"
                    aria-expanded="false" aria-controls="collapseExample" id="seeUrls">
                    See urls added
                </a>
                <div class="collapse" id="collapseExample">
                    <div class="card card-body " style="width: 28rem; display: inline-table;" id="urlsCollapse">
                    </div>
                </div>
            </div>
            <!-- keywords input -->
            <div class="form-label mt-2">Keyword</div>
            <div class="d-flex">
                <div>
                    <input id="key_word" style="width: 25rem;" class="form-control" />
                </div>
                <button type="button" class="btn btn-secondary" id="addKeywords" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="Add this keyword">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-plus-circle fw-bold" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path
                            d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    </svg>
                </button>
            </div>
            <!-- keywords collapse -->
            <div class="d-inline-block mt-2">
                <div id="keywordsCounter"></div>
                <a role="button" href="" data-bs-toggle="collapse" data-bs-target="#collapse" aria-expanded="false"
                    aria-controls="collapseExample" id="seeKeywords">
                    See Keywords added
                </a>
                <div class="collapse" id="collapse">
                    <div class="card card-body" style="width: 28rem;" id="keywordsCollapse">
                    </div>
                </div>
            </div>
            <!-- websites checkboxes -->
            <h3 class="mt-4 mb-4">Available websites</h3>
            <div data-bs-toggle="collapse" data-bs-target="#twitterCollapse" aria-expanded="false"
                aria-controls="collapseExample">
                <div id="twiterBtn" class="btn btn-primary mt-1 d-flex justify-content-between">
                    <svg xmlns="http://www.w3.org/2000/svg" style="margin-top: 4px;" width="20" height="20"
                        fill="currentColor" class="bi bi-twitter" viewBox="0 0 16 16">
                        <path
                            d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" />
                    </svg>
                    <div type="checkbox" class="form-label" style="cursor: pointer;">Twitter</div>
                    <input type="checkbox" class="form-check-input" id="twiterCheckbox" />
                </div>
            </div>
            <div class="collapse" id="twitterCollapse">
                <div class="form-labe mt-2">Max Results</div>
                <input style="width: 8rem;" type="number" class="form-control" id="tiwtterMaxResults" />
            </div>
            <!-- collapse -->
            <div data-bs-toggle="collapse" data-bs-target="#youtubeCollapse" aria-expanded="false"
                aria-controls="collapseExample">
                <div id="youtubeBtn" class="btn btn-danger mt-3 d-flex justify-content-between">
                    <svg xmlns="http://www.w3.org/2000/svg" style="margin-top: 4px;" width="20" height="20"
                        fill="currentColor" class="bi bi-youtube" viewBox="0 0 16 16">
                        <path
                            d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z" />
                    </svg>
                    <div class="form-label" style="cursor: pointer;">Youtube</div>
                    <input type="checkbox" class="form-check-input" id="youtubeCheckbox" />
                </div>
            </div>
            <div class="collapse" id="youtubeCollapse">
                <div class="form-labe mt-2">Max Results</div>
                <input style="width: 8rem;" type="number" class="form-control" id="youtubeMaxResults" />
            </div>
            <!-- collapse -->
            <div data-bs-toggle="collapse" data-bs-target="#InstaCollapse" aria-expanded="false"
                aria-controls="collapseExample">
                <div id="instagrameBtn" class="btn mt-3 d-flex font-weight-bold justify-content-between"
                    style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: #fff;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        style="margin-top: 4px;" class="bi bi-instagram" viewBox="0 0 16 16">
                        <path
                            d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z" />
                    </svg>
                    <div class="form-label" style="cursor: pointer;">Instagrame</div>
                    <input type="checkbox" class="form-check-input" id="instagrameCheckbox" />
                </div>
            </div>
            <!-- collapse -->
            <div class="collapse" id="InstaCollapse">
                <div class="form-labe mt-2">Max Results</div>
                <input style="width: 8rem;" type="number" class="form-control" id="instaMaxResults" />
            </div>
        </div>
        <div class="card-action d-flex justify-content-center">
            <input type="button" id="submit" class="btn btn-primary mt-4" value="Start Scraping" />
        </div>
    </form>
</div>
<script>
    var twitterCheckbox = document.getElementById('twiterCheckbox')
    var youtubeCheckbox = document.getElementById('youtubeCheckbox')
    var instagrameCheckbox = document.getElementById('instagrameCheckbox')
    var twiterBtn = document.getElementById('twiterBtn')
    var youtubeBtn = document.getElementById('youtubeBtn')
    var instagrameBtn = document.getElementById('instagrameBtn')
    var urlInput = document.getElementById('url')
    var urlsCollapse = document.getElementById('urlsCollapse')
    var keywordsCollapse = document.getElementById('keywordsCollapse')
    var seeUrls = document.getElementById('seeUrls')
    var seeKeywords = document.getElementById('seeKeywords')
    var urlCounter = document.getElementById('urlCounter')
    var keywordsCounter = document.getElementById('keywordsCounter')
    var keyWordInput = document.getElementById('key_word')
    var addURLBtn = document.getElementById('addURL')
    var addKeywordsBtn = document.getElementById('addKeywords')
    var submit = document.getElementById('submit')
    var deleteKeywordBtn = document.getElementById('deletKeyword')
    var twitterMaxResults = document.getElementById('tiwtterMaxResults')
    var youtubeMaxResults = document.getElementById('youtubeMaxResults')
    var instaMaxResults = document.getElementById('instaMaxResults')
    var deletedUrlBtns
    var urls = []
    var keywords = []
    // actions 
    const twiterCheckboxAction = () => twiterCheckbox.checked = !twiterCheckbox.checked
    const youtubeCheckboxAction = () => youtubeCheckbox.checked = !youtubeCheckbox.checked
    const instagrameCheckboxAction = () => instagrameCheckbox.checked = !instagrameCheckbox.checked
    const deleteKeyword = (e) => {
        const deletedKeyword = e.target.value
        keywords = keywords.filter(keyword => keyword !== deletedKeyword)
        deleteKeywordBtn = document.getElementById('deletKeyword')
        displayKeywords()
        keywordsCounter.innerHTML = `<p class="fw-lighter mb-1">${keywords.length} ${keywords.length > 1 ? 'keywords' : 'keyword'} added</p>`
    }
    const deleteUrl = (e) => {
        const deletedUrl = e.target.value
        urls = urls.filter(url => url !== deletedUrl)
        urlsCollapse.innerHTML = ""
        displayUrls()
        urlCounter.innerHTML = `<p class="fw-lighter mb-1">${urls.length} ${urls.length > 1 ? 'urls' : 'url'} added</p>`
    }
    function deleterListener(func) {
        btns = document.getElementsByClassName('btnl')
        for (var i = 0; i < btns.length; i++) {
            btns[i].onclick = func
        }
    }

    const displayUrls = (e) => {
        urlsCollapse.innerHTML = ""
        if (urls.length > 0) {
            urls.map(url => {
                urlsCollapse.innerHTML += `
                <a href="${url}">${url.substring(0, 40)}...</a>
                <button value="${url}" style="width:8px; height:5px; margin-left: 10px;"  type="button" class="btn btn-sm btnl btn-danger">
                </button>
                `
            })
            deleterListener(deleteUrl)
        }

    }

    const displayKeywords = () => {
        keywordsCollapse.innerHTML = ""
        if (keywords.length > 0) {
            keywords.map(keyword => {
                keywordsCollapse.innerHTML += `
                <div class="d-flex">
                    <p>${keyword.substring(0, 50)}</p>
                    <button value="${keyword}" style="width:8px; height:5px; margin-left: 10px;"  type="button" class="btn btn-sm btnl btn-danger mt-2"">
                        </button>
                <div>`
            })
            deleterListener(deleteKeyword)
        }
    }

    const addUrl = () => {
        if (validateUrl(urlInput.value) && validateDuplicated(urlInput.value, urls)) {
            const url = urlInput.value
            urls = [...urls, url]
            urlInput.className = "form-control"
            urlCounter.innerHTML = `<p class="fw-lighter mb-1">${urls.length} ${urls.length > 1 ? 'urls' : 'url'} added</p>`
        } else {
            if (urlInput.classList[2] === undefined) {
                urlInput.className += ' is-invalid'
                if (!validateDuplicated(urlInput.value, urls)) {
                    urlCounter.innerHTML = '<p class="fw-lighter text-danger mb-2">These url already in</p>'
                } else {
                    urlCounter.innerHTML = '<p class="fw-lighter text-danger mb-2">Please enter valid url</p>'
                }
            }
        }
        urlInput.value = ''
    }
    const addKeyword = () => {
        if (validateDuplicated(keyWordInput.value, keywords) && keyWordInput.value !== '') {
            keywords = [...keywords, keyWordInput.value]
            keywordsCounter.innerHTML = `<p class="fw-lighter mb-1">${keywords.length} ${keywords.length > 1 ? 'keywords' : 'keyword'} added</p>`
            keyWordInput.className = "form-control"
        } else {
            if (keyWordInput.classList[2] === undefined) {
                keyWordInput.className += ' is-invalid'
                if (!validateDuplicated(keyWordInput.value, keywords)) {
                    keywordsCounter.innerHTML = '<p class="fw-lighter text-danger mb-2">These keyword already in</p>'
                } else {
                    keywordsCounter.innerHTML = '<p class="fw-lighter text-danger mb-2">Please enter valid keyword</p>'
                }
            }
        }
        keyWordInput.value = ''
    }
    // validators
    function validateMaxResults() {
        const insta = instaMaxResults.valueAsNumber !== undefined && instagrameCheckbox.checked
        const youtube = youtubeMaxResults.valueAsNumber !== undefined && youtubeCheckbox.checked
        const twitter = twitterMaxResults.valueAsNumber !== undefined && twitterCheckbox.checked
        if (insta || youtube || twitter) {
            return true;
        }
        return false
    }
    function validateUrl(value) {
        return /^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(value);
    }
    function validateForm() {
        var checkboxValidation = twitterCheckbox.checked || youtubeCheckbox.checked || instagrameCheckbox.checked
        var inputsValidation = urls.length > 0 || keywords.length > 0
        if (checkboxValidation && inputsValidation && validateMaxResults()) {
            return true
        }
        return false
    }

    function validateDuplicated(addedItem, arr) {
        if (arr.length > 0) {
            const filtredArr = arr.filter(item => item === addedItem)
            if (filtredArr.length <= 0) {
                return true
            }
            return false
        }
        return true
    }

    // update page content
    function updatePage(data) {
        document.body.innerHTML = `
        <div style="margin-top: 10px;" class="container-fluid d-flex flex-wrap">
            <table class=" table table-bordered">
            <thead class="table-dark">
                <tr>
                <th class="text-center" scope="col-2">id</th>
                <th class="text-center" scope="col-7">comment</th>
                </tr>
            </thead>
            <tbody id="body">
            </tbody>
            </table>
        </div>
        `
        let i = 0
        let content = ''
        data.map(comment => {
            content +=
                `
                <tr id=${i}>
                    <td class="text-center col" >${i}</td>
                    <td class="text-center col-11" >${comment}</td>
                </tr>
            `
            i++
        })
        addComments(content)
    }
    function addComments(content) {
        var body = document.getElementById("body")
        body.innerHTML = content
    }

    async function sendData() {
        if (validateForm()) {
            document.body.innerHTML = `
            <div class="container">
              <div class="dash uno"></div>
              <div class="dash dos"></div>
              <div class="dash tres"></div>
              <div class="dash cuatro"></div><br>
              <h5 class="ml-2">Please wait until scraping operation finished ...</h5>
            </div>
            `
            await $.ajax({
                url: "/scraper",
                type: "POST",
                data: JSON.stringify({
                    youtube: youtubeCheckbox.checked ? youtubeMaxResults.valueAsNumber : null,
                    instagrame: instagrameCheckbox.checked ? instaMaxResults.valueAsNumber : null,
                    twitter: twitterCheckbox.checked ? twitterMaxResults.valueAsNumber : null,
                    urls: urls,
                    keywords: keywords,
                }),
                contentType: "application/json; charset=utf-8",
                success: function (data, textStatus) {
                    if (data) {
                        updatePage(data)
                    }
                }
            });
            keyWordInput.value = ''
            keywordsCounter.innerHTML = ""
            keywords = []
            urlInput.value = ''
            urlCounter.innerHTML = ""
            urls = []
            youtubeCheckbox.checked = false
            instagrameCheckbox.checked = false
            twitterCheckbox.checked = false
        } else {
            if (urlInput.classList[2] === undefined) {
                urlInput.className += ' is-invalid'
            }
            if (keyWordInput.classList[2] === undefined) {
                keyWordInput.className += ' is-invalid'
            }
        }
    }
    // listeners
    twiterBtn.addEventListener('click', twiterCheckboxAction, false)
    twiterCheckbox.addEventListener('click', twiterCheckboxAction, false)
    youtubeBtn.addEventListener('click', youtubeCheckboxAction, false)
    youtubeCheckbox.addEventListener('click', youtubeCheckboxAction, false)
    instagrameBtn.addEventListener('click', instagrameCheckboxAction, false)
    instagrameCheckbox.addEventListener('click', instagrameCheckboxAction, false)
    addURLBtn.addEventListener('click', addUrl, false)
    addKeywordsBtn.addEventListener('click', addKeyword, false)
    submit.addEventListener('click', sendData, false)
    seeUrls.addEventListener('click', displayUrls, false)
    seeKeywords.addEventListener('click', displayKeywords, false)

</script>
{% endblock %}